<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SP-Energy | Gráficas y Tablas</title>
    <link rel="stylesheet" href="style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* CAMBIO AQUÍ: ESTILOS PARA PONER TEXTO A LA DERECHA DE LA GRÁFICA */
        .chart-layout {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
        }
        .chart-container {
            flex: 3; /* La gráfica ocupa 75% */
            min-width: 300px;
            height: 400px;
        }
        .info-box {
            flex: 1; /* El texto ocupa 25% */
            min-width: 200px;
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            border-left: 5px solid #FFD700; /* Borde amarillo */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .info-box h4 { margin-top: 0; color: #333; }
        .highlight { color: #e67e22; font-weight: bold; font-size: 1.2em; }

        /* ESTILOS PARA REFERENCIAS BIBLIOGRÁFICAS */
        .references-section {
            background-color: #2c3e50;
            color: white;
            padding: 40px 20px;
            margin-top: 50px;
        }
        .references-section h3 { color: #FFD700; border-bottom: 1px solid #555; padding-bottom: 10px; }
        .references-section ul { list-style: none; padding: 0; }
        .references-section li { margin-bottom: 10px; }
        .references-section a { color: #3498db; text-decoration: none; }
        .references-section a:hover { text-decoration: underline; color: #FFD700; }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="logo-container">
            <span class="logo-text">SP-ENERGY <span class="sun-icon">☀️</span></span>
        </div>
        <div class="slogan-container">
            <h1>Energía Solar para Todos</h1>
        </div>
        <div class="spacer"></div> 
    </header>

    <nav class="navbar">
        <ul>
            <li><a href="index.html">Inicio</a></li>
            <li><a href="mapa.html">Mapa Interactivo</a></li>
            <li><a href="graficas.html" class="active">Gráficas y Tablas</a></li>
            <li><a href="emisiones.html">Emisiones</a></li>
            <li><a href="info.html">Contacto</a></li>
        </ul>
    </nav>

    <main class="main-container">
        <h2 class="section-title">Análisis de Datos del SEN</h2>

        <section class="graph-card">
            <h2>Capacidad y generación solar fotovoltaica (2010–2024)</h2>
            <p>Evolución exponencial al 2024: La capacidad solar creció de casi cero a 7,961 MW, y la generación alcanzó 18,640 GWh, consolidándose como tecnología clave.</p>

            <div class="grid-2">
                <div>
                    <h3>Capacidad (MW) y Participación</h3>
                    <canvas id="chartCapSolar"></canvas>
                </div>
                <div>
                    <h3>Generación (GWh) y Participación</h3>
                    <canvas id="chartGenSolar"></canvas>
                </div>
            </div>
        </section>

        <section class="graph-card">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
                <h2>Indicadores Generales del SEN</h2>
                <div class="view-toggle">
                    <button id="btnMixChart" class="btn primary">Ver gráficas</button>
                    <button id="btnMixTable" class="btn">Ver tabla</button>
                </div>
            </div>
            <p>Selecciona una variable para ver su comportamiento histórico.</p>

            <div id="mixChartArea">
                <div class="controls-row">
                    <label>Variable:</label>
                    <select id="senVariableSelect">
                        <option value="capacidad">Capacidad Total</option>
                        <option value="generacion">Generación Total</option>
                        <option value="demanda">Demanda Máxima</option>
                        <option value="consumo">Consumo (Bruto/Final)</option>
                    </select>
                </div>

                <div class="chart-layout">
                    <div class="chart-container">
                        <canvas id="chartSEN"></canvas>
                    </div>
                    <div class="info-box" id="senInfoBox">
                        <h4>Análisis 2010-2024</h4>
                        <p>Cargando datos...</p>
                    </div>
                </div>
            </div>

            <div id="mixTableArea" style="display:none; overflow-x:auto;">
                <table class="data-table">
                    <thead id="mixTableHead"></thead>
                    <tbody id="mixTableBody"></tbody>
                </table>
            </div>
        </section>

        <section class="graph-card">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
                <h2>Evolución por Tecnología (2010–2024)</h2>
                <div class="view-toggle">
                    <button id="btnTechCap" class="btn primary">Capacidad</button>
                    <button id="btnTechGen" class="btn">Generación</button>
                </div>
            </div>
            <p>Al 2024, las tecnologías limpias muestran un crecimiento sostenido frente a las fósiles, diversificando la matriz energética nacional.</p>
            
            <div style="height: 500px; width: 100%;">
                <canvas id="chartTechStack"></canvas>
            </div>
        </section>

        <section class="graph-card">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
                <h2>Series por Región</h2>
                <div class="view-toggle">
                    <button id="btnRegChart" class="btn primary">Ver gráfica</button>
                    <button id="btnRegTable" class="btn">Ver tabla</button>
                </div>
            </div>

            <div id="regChartArea">
                <div class="controls-row">
                    <select id="regionSelect">
                        <option value="CEN">CEN</option><option value="ORI">ORI</option><option value="OCC">OCC</option>
                        <option value="NOR">NOR</option><option value="NTE">NTE</option><option value="NES">NES</option>
                        <option value="PEN">PEN</option><option value="SIBC">SIBC</option><option value="SIBCS">SIBCS</option>
                        <option value="SIMUL">SIMUL</option><option value="SIN">SIN</option>
                    </select>
                    <select id="variableSelect">
                        <option value="demanda">Demanda Máxima</option>
                        <option value="consumoBruto">Consumo Bruto</option>
                        <option value="consumoFinal">Consumo Final</option>
                    </select>
                </div>

                <div class="chart-layout">
                    <div class="chart-container">
                        <canvas id="chartRegion"></canvas>
                    </div>
                    <div class="info-box" id="regInfoBox">
                        <h4>Análisis Regional</h4>
                        <p>Selecciona una región...</p>
                    </div>
                </div>
            </div>

            <div id="regTableArea" style="display:none; overflow-x:auto;">
                <table class="data-table">
                    <thead><tr><th>Año</th><th>Valor</th><th>Participación (%)</th></tr></thead>
                    <tbody id="regTableBody"></tbody>
                </table>
            </div>
        </section>

    </main>

    <div class="references-section">
        <div style="max-width: 1200px; margin: 0 auto;">
            <h3>Referencias Bibliográficas</h3>
            <ul>
                <li>
                    <strong>Centro Nacional de Control de Energía (CENACE):</strong> 
                    <a href="https://www.cenace.gob.mx/Paginas/SIM/Reportes/EnergiaGeneradaTipoTec.aspx" target="_blank">Reportes de Energía Generada por Tipo de Tecnología</a>
                </li>
                <li><strong>Plan de Desarrollo del Sector Eléctrico (PDSE)</strong></li>
                <li>
                    <strong>Programa de Desarrollo del Sistema Eléctrico Nacional (PRODESEN):</strong> 
                    <a href="https://www.cenace.gob.mx/Docs/16_MARCOREGULATORIO/Prodecen/20%202024-2038%20Cap%C3%ADtulos%201%20al%206.pdf" target="_blank">Capítulos 1 al 6 (2024-2038)</a>
                </li>
                <li>
                    <strong>Sistema de Información Energética (SIE):</strong> 
                    <a href="https://sie.energia.gob.mx/inicio/" target="_blank">Portal de Inicio</a>
                </li>
            </ul>
        </div>
    </div>

    <footer><p>&copy; 2025 SP-Energy.</p></footer>

    <script>
    const years = [2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020,2021,2022,2023,2024];
    const techColors = {"Carboeléctrica":"#2c3e50","Térmica Convencional":"#7f8c8d","Combustión interna":"#34495e","Turbogás":"#d35400","Ciclo combinado":"#c0392b","Nucleoeléctrica":"#e67e22","Cogeneración eficiente":"#8e44ad","Hidroeléctrica":"#2980b9","Geotérmica":"#9b59b6","Eólica":"#27ae60","Solar fotovoltaica":"#f1c40f","Híbrido FV / Solar Baterías":"#f39c12","Bioenergía":"#16a085"};

    // CAMBIO AQUÍ: Función para hacer los colores muy transparentes (0.2)
    function hexToRgba(hex, alpha) {
        let c;
        if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){
            c= hex.substring(1).split('');
            if(c.length== 3){ c= [c[0], c[0], c[1], c[1], c[2], c[2]]; }
            c= '0x'+c.join('');
            return 'rgba('+[(c>>16)&255, (c>>8)&255, c&255].join(',')+','+alpha+')';
        }
        return hex;
    }

    // Datos SEN
    const capTotal = [55090,54656,55692,57413,62359,63545,73242,68051,72958,78447,83122,86154,87131,89007,90543];
    const genTotal = [271483,277894,281545,286218,280365,287660,298426,302880,310686,317821,312348,323527,333964,346501,352305];
    const demandaSen = [41750,43324,43920,44323,44398,45601,47348,49049,50825,52340,51225,52686,54489,57958,59601];
    const consumoBrutoSen = [253460,269831,275033,275497,280161,288224,298792,309726,318233,324921,315969,329032,340613,351584,359807];
    const consumoFinalSen = [199713,214098,219994,222830,228635,237200,248195,258895,268701,274915,266238,277259,288687,298599,304012];

    // Datos Tecnologías
    const techDataCap = { "Carboeléctrica": [5393,5393,5419,5419,5463,5463,5378,5463,5463,5463,5463,5463,5463,5463,5463], "Térmica Convencional": [12876,12560,11923,11923,12665,12665,13174,12665,12315,11831,11809,11793,11343,11300,11300], "Combustión interna": [241,238,281,290,540,540,1453,739,880,891,850,701,728,729,717], "Turbogás": [2914,2873,3355,2510,2399,2849,5052,2960,2960,2960,3545,3744,3815,3888,3953], "Ciclo combinado": [19283,19290,19424,21755,22699,22949,27274,25340,27393,30402,31948,33640,34413,35178,35669], "Nucleoeléctrica": [1365,1365,1610,1400,1400,1510,1608,1608,1608,1608,1608,1608,1608,1608,1608], "Cogeneración eficiente": [0,0,0,0,819,943,1036,1322,1709,1710,2305,2305,2308,2322,2293], "Hidroeléctrica": [11586,11582,11685,11762,12552,12560,12589,12612,12612,12612,12612,12614,12613,12612,12612], "Geotérmica": [965,887,812,823,874,899,909,899,899,899,951,976,976,976,976], "Eólica": [449,450,1097,1431,2660,2877,3735,3898,4866,6050,6504,6977,6921,7055,7512], "Solar fotovoltaica": [0,0,1,11,55,57,145,171,1878,3646,5149,5955,6515,7437,7961], "Híbrido FV / Solar Baterías": [0,0,0,0,0,0,0,0,0,0,0,0,20,32,92], "Bioenergía": [18,18,85,89,233,233,889,374,375,375,378,378,408,407,387] };
    const techDataGen = { "Carboeléctrica": [35371,35631,35019,34642,33613,33599,34208,28665,27347,21611,12525,8704,14194,14230,12968], "Térmica Convencional": [47376,51640,58402,53770,37682,39713,40795,42884,39345,38020,22405,22196,20001,30358,28228], "Combustión interna": [1364,1404,1541,1677,1499,1740,1915,2306,2589,3187,2841,2121,1834,3621,3847], "Turbogás": [2217,2123,3168,2611,3422,6301,8183,8435,9508,10904,8664,11150,10471,12336,12017], "Ciclo combinado": [130269,129577,130741,140777,139350,144624,150597,159163,163877,175506,185638,186715,198355,205598,212819], "Nucleoeléctrica": [6019,9640,8193,11389,9677,11577,10567,10572,13200,10881,10864,11606,10539,12043,11978], "Cogeneración eficiente": [1926,1924,1928,1921,2634,3519,4310,2054,2310,3259,4188,3349,1376,4136,3912], "Hidroeléctrica": [38684,37639,32835,28869,38875,30858,30847,31664,32234,23602,26817,34717,35561,20609,23800], "Geotérmica": [6934,6615,5887,6152,6000,6331,6150,5747,5065,5061,4575,4243,4412,4161,3576], "Eólica": [1298,1675,3688,4243,7189,8991,10295,10456,12435,16727,19703,21075,20314,20700,19987], "Solar fotovoltaica": [0,0,3,20,83,45,151,349,2176,8394,13528,17069,16290,18210,18640], "Bioenergía": [25,26,140,147,341,362,408,585,600,669,600,582,617,499,533] };

    const demandaRegion = { "CEN": [9004,8844,8651,8411,8192,8151,8567,8705,8805,8754,8717,8450,8466,8619,8848], "ORI": [6356,6577,6626,6709,6767,6960,7128,7299,7594,7923,7461,7868,8203,8783,9034], "OCC": [8175,8669,8975,9207,9104,9374,9351,9842,10373,10096,9763,10292,10537,11478,11834], "NOR": [3617,3772,3870,4087,4034,4154,4350,4582,4759,5310,5220,5343,5342,5808,5909], "NTE": [3385,3682,3725,3841,3955,3986,4258,4608,4639,4851,4976,5042,5343,5446,5540], "NES": [7070,7587,7798,7781,7876,8248,8710,8846,9202,9707,9399,9674,10237,10962,11109], "PEN": [1520,1544,1558,1628,1664,1789,1893,1955,2061,2246,2014,2210,2372,2698,2969], "SIBC": [2229,2237,2302,2225,2350,2479,2621,2699,2863,2887,3132,3215,3361,3457,3635], "SIBCS": [368,385,389,407,428,432,442,484,500,536,513,560,596,675,689], "SIMUL": [136,138,143,147,151,146,151,152,155,155,159,161,164,165,170], "SIN": [39127,40675,41203,41664,41592,42662,44257,45837,47433,48887,47550,48879,50500,53794,55243] };
    const consumoBrutoRegion = { "CEN": [58422,59303,59061,58086,57423,57844,59103,60685,61293,60853,57429,58272,59866,60160,60059], "ORI": [40098,42447,43835,44224,44901,46587,47642,48583,50285,51655,50436,53051,54643,56633,58547], "OCC": [51407,55871,57470,57779,59345,61025,62808,66696,68107,69697,68154,70900,73763,76564,77541], "NOR": [17339,19251,20097,20466,21089,21642,23389,24293,24684,24966,26104,26449,26332,28259,29126], "NTE": [20403,22116,22484,22679,23150,23734,24696,25949,27000,28868,29291,29808,30596,31905,32711], "NES": [43442,47379,47776,47581,48559,50114,52895,54423,56426,57411,54239,57901,60806,62170,64080], "PEN": [9206,9735,9938,10300,10635,11610,12129,12498,12989,13872,12497,13613,14677,16054,16930], "SIBC": [10991,11426,12020,11996,12598,13122,13438,13825,14535,14621,14938,15966,16686,16346,17218], "SIBCS": [2016,2165,2209,2239,2310,2400,2541,2622,2759,2823,2722,2911,3080,3328,3425], "SIMUL": [136,138,143,147,151,146,151,152,155,155,159,161,164,165,170], "SIN": [240317,256103,260661,261115,265101,272557,282662,293127,300783,307321,298150,309994,320683,331744,338994] };
    const consumoFinalRegion = { "CEN": [34789,36540,37792,38818,39064,40364,45070,46423,48269,48590,46362,47262,48988,49709,49411], "ORI": [31734,33567,34836,35292,35986,37286,38423,39607,41840,42709,40722,42530,44503,46528,48022], "OCC": [45144,48599,49959,50428,51952,53884,53290,57743,58995,60871,59536,61885,64629,66822,67732], "NOR": [14567,16264,16895,17263,17796,18497,20017,20823,21277,21441,22247,22332,22580,24037,24651], "NTE": [17052,18340,18656,18743,19596,20368,21231,22466,23565,24592,24508,24699,25268,25909,26592], "NES": [37261,40608,40941,40989,41947,43231,45455,45957,47973,48723,45613,49321,51806,53160,53876], "PEN": [7732,8142,8354,8660,9032,9730,10342,11055,11399,12425,11204,11827,13043,14414,14934], "SIBC": [9605,10044,10514,10554,11122,11618,12005,12429,12798,12937,13521,14671,14991,14879,15565], "SIBCS": [1722,1882,1932,1965,2016,2098,2239,2267,2460,2501,2394,2597,2742,2995,3079], "SIMUL": [107,112,115,118,124,124,123,125,125,126,131,135,137,146,150], "SIN": [94.27,94.38,94.29,94.33,94.2,94.17,94.21,94.27,94.28,94.34,93.97,93.72,93.81,93.97,93.82] };
    
    const capSolar = techDataCap["Solar fotovoltaica"];
    const genSolar = techDataGen["Solar fotovoltaica"];
    const capShare = [0.0,0.0,0.0,0.02,0.09,0.09,0.2,0.25,2.57,4.65,6.19,6.91,7.48,8.36,8.79];
    const genShare = [0.0,0.0,0.0,0.01,0.03,0.02,0.05,0.12,0.7,2.64,4.33,5.28,4.88,5.26,5.29];
    const regShare = { "CEN": [21.57,20.41,19.7,18.98,18.45,17.87,18.09,17.75,17.32,16.73,17.02,16.04,15.54,14.87,14.85], "ORI": [15.22,15.18,15.09,15.14,15.24,15.26,15.05,14.88,14.94,15.14,14.57,14.93,15.05,15.15,15.16], "OCC": [19.58,20.01,20.43,20.77,20.51,20.56,19.75,20.07,20.41,19.29,19.06,19.53,19.34,19.8,19.86], "NOR": [8.66,8.71,8.81,9.22,9.09,9.11,9.19,9.34,9.36,10.15,10.19,10.14,9.8,10.02,9.91], "NTE": [8.11,8.5,8.48,8.67,8.91,8.74,8.99,9.39,9.13,9.27,9.71,9.57,9.81,9.4,9.3], "NES": [16.93,17.51,17.76,17.56,17.74,18.09,18.4,18.04,18.11,18.55,18.35,18.36,18.79,18.91,18.64], "PEN": [3.64,3.56,3.55,3.67,3.75,3.92,4.0,3.99,4.06,4.29,3.93,4.19,4.35,4.66,4.98], "SIBC": [5.34,5.16,5.24,5.02,5.29,5.44,5.54,5.5,5.63,5.52,6.11,6.1,6.17,5.96,6.1], "SIBCS": [0.88,0.89,0.89,0.92,0.96,0.95,0.93,0.99,0.98,1.02,1.0,1.06,1.09,1.16,1.16], "SIMUL": [0.06,0.06,0.06,0.06,0.06,0.06,0.06,0.06,0.06,0.06,0.06,0.06,0.06,0.06,0.06], "SIN": [93.72,93.89,93.81,94.0,93.68,93.55,93.47,93.45,93.33,93.4,92.83,92.77,92.68,92.82,92.69] };

    // Lógica de Cálculo de Crecimiento para los recuadros de texto
    function calcStats(arr) {
        let start = arr[0];
        let end = arr[arr.length-1];
        let pct = ((end - start) / start) * 100;
        return { start, end, pct };
    }

    // 1. Gráficas Solares
    function makeDualSolarChart(ctx, labels, val, share, labelVal, yLabel) {
        return new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: labelVal, data: val, yAxisID: 'y', fill: true, tension: 0.25, backgroundColor: 'rgba(241, 196, 15, 0.2)', borderColor: '#f1c40f' },
                    { label: 'Participación (%)', data: share, yAxisID: 'y1', fill: false, tension: 0.25, borderDash: [5,4], borderColor: '#e74c3c' }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                plugins: { legend: { position: 'top' } },
                scales: { y: { title: { display: true, text: yLabel } }, y1: { position: 'right', grid: { drawOnChartArea: false } } }
            }
        });
    }

    // 2. Stacked Technology (SOLUCIÓN AL CURSOR)
    let chartTechStack;
    function initTechStackChart() {
        const ctx = document.getElementById('chartTechStack');
        const btnCap = document.getElementById('btnTechCap');
        const btnGen = document.getElementById('btnTechGen');

        function buildDatasets(source) {
            return Object.keys(source).map(tech => ({
                label: tech,
                data: source[tech],
                // CAMBIO AQUÍ: Opacidad 0.2 + HitRadius 50 (Esto arregla la interacción)
                backgroundColor: hexToRgba(techColors[tech] || '#999', 0.2), 
                borderColor: techColors[tech] || '#999',
                borderWidth: 1,
                fill: true,
                pointRadius: 0,
                pointHitRadius: 50 
            }));
        }

        function updateChart(type) {
            if(type === 'capacidad') { btnCap.classList.add('primary'); btnGen.classList.remove('primary'); }
            else { btnGen.classList.add('primary'); btnCap.classList.remove('primary'); }
            
            const src = (type === 'capacidad') ? techDataCap : techDataGen;
            const txt = (type === 'capacidad') ? 'Capacidad (MW)' : 'Generación (GWh)';
            if(chartTechStack) chartTechStack.destroy();

            chartTechStack = new Chart(ctx, {
                type: 'line',
                data: { labels: years, datasets: buildDatasets(src) },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    // CAMBIO AQUÍ: Interaction mode 'nearest' con intersect true
                    interaction: { mode: 'nearest', axis: 'x', intersect: true },
                    plugins: {
                        tooltip: { callbacks: { label: (c) => ` ${c.dataset.label}: ${c.raw.toLocaleString()} ${txt}` } },
                        legend: { position: 'bottom', labels: { boxWidth: 10 } }
                    },
                    scales: { y: { stacked: true, title: { display: true, text: txt } } }
                }
            });
        }
        btnCap.onclick = () => updateChart('capacidad');
        btnGen.onclick = () => updateChart('generacion');
        updateChart('capacidad');
    }

    // 3. SEN con Texto Dinámico
    let chartSEN;
    function updateSenChart() {
        const v = document.getElementById('senVariableSelect').value;
        const ctx = document.getElementById('chartSEN');
        const info = document.getElementById('senInfoText');
        if(chartSEN) chartSEN.destroy();

        let data = [], lbl = "", unit = "";
        if(v==='capacidad'){ data=capTotal; lbl='Capacidad Total'; unit='MW'; }
        else if(v==='generacion'){ data=genTotal; lbl='Generación Total'; unit='GWh'; }
        else if(v==='demanda'){ data=demandaSen; lbl='Demanda Máx'; unit='MW'; }
        else { data=consumoBrutoSen; lbl='Consumo Bruto'; unit='GWh'; }

        let dsets = [];
        if(v==='consumo') {
            dsets.push({ label: 'Consumo Bruto', data: consumoBrutoSen, fill:true, tension:0.25, backgroundColor:'rgba(52,152,219,0.2)', borderColor:'#3498db' });
            dsets.push({ label: 'Consumo Final', data: consumoFinalSen, fill:false, tension:0.25, borderColor:'#2ecc71' });
        } else {
            dsets.push({ label: lbl, data: data, fill:true, tension:0.25, backgroundColor:'rgba(52,152,219,0.2)', borderColor:'#3498db' });
        }

        chartSEN = new Chart(ctx, {
            type: 'line', data: { labels: years, datasets: dsets },
            options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, scales: { y: { title: { display: true, text: unit } } } }
        });

        // Llenar Texto Dinámico
        const s = calcStats(data);
        info.innerHTML = `<h4>${lbl}</h4><span class="metric-big">${s.pct.toFixed(1)}%</span><p class="metric-desc">Crecimiento acumulado (2010-2024)</p><p>Inicio: <b>${s.start.toLocaleString()}</b><br>Cierre: <b>${s.end.toLocaleString()}</b> ${unit}</p>`;

        // Llenar Tabla
        const tb = document.getElementById('mixTableBody'); tb.innerHTML = '';
        document.getElementById('mixTableHead').innerHTML = `<tr><th>Año</th><th>${lbl}</th></tr>`;
        years.forEach((y,i) => { tb.innerHTML += `<tr><td>${y}</td><td>${v==='consumo' ? consumoBrutoSen[i].toLocaleString()+' / '+consumoFinalSen[i].toLocaleString() : data[i].toLocaleString()}</td></tr>` });
    }

    // 4. Regiones con Texto Dinámico
    let chartRegion;
    function updateRegChart() {
        const r = document.getElementById('regionSelect').value;
        const v = document.getElementById('variableSelect').value;
        const info = document.getElementById('regInfoText');
        const ctx = document.getElementById('chartRegion');
        if(chartRegion) chartRegion.destroy();

        let dReg, unit, lbl;
        if(v==='demanda'){ dReg=demandaRegion[r]; unit='MW'; lbl='Demanda'; }
        else if(v==='consumoBruto'){ dReg=consumoBrutoRegion[r]; unit='GWh'; lbl='Consumo Bruto'; }
        else { dReg=consumoFinalRegion[r]; unit='GWh'; lbl='Consumo Final'; }
        const dShare = regShare[r];

        chartRegion = new Chart(ctx, {
            type: 'line', data: { labels: years, datasets: [
                { label: `${lbl} ${r}`, data: dReg, yAxisID: 'y', fill:true, tension:0.25, backgroundColor:'rgba(155,89,182,0.2)', borderColor:'#9b59b6' },
                { label: 'Participación', data: dShare, yAxisID: 'y1', fill:false, borderDash:[5,4], borderColor:'#34495e' }
            ]},
            options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, scales: { y: { position:'left', title:{display:true,text:unit} }, y1: { position:'right', grid:{drawOnChartArea:false} } } }
        });

        const s = calcStats(dReg);
        info.innerHTML = `<h4>${r}: ${lbl}</h4><span class="metric-big">${s.pct.toFixed(1)}%</span><p class="metric-desc">Variación (2010-2024)</p><p>Actual: <b>${s.end.toLocaleString()} ${unit}</b><br>Participación SEN: <b>${dShare[dShare.length-1]}%</b></p>`;

        const tb = document.getElementById('regTableBody'); tb.innerHTML = '';
        years.forEach((y,i) => { tb.innerHTML += `<tr><td>${y}</td><td>${dReg[i].toLocaleString()}</td><td>${dShare[i]}%</td></tr>` });
    }

    // Inicialización
    window.onload = function() {
        makeDualSolarChart(document.getElementById('chartCapSolar'), years, capSolar, capShare, 'Capacidad (MW)', 'MW');
        makeDualSolarChart(document.getElementById('chartGenSolar'), years, genSolar, genShare, 'Generación (GWh)', 'GWh');
        initTechStackChart();

        document.getElementById('senVariableSelect').onchange = updateSenChart;
        document.getElementById('btnMixChart').onclick = () => { document.getElementById('mixChartContainer').style.display=''; document.getElementById('mixTableContainer').style.display='none'; };
        document.getElementById('btnMixTable').onclick = () => { document.getElementById('mixChartContainer').style.display='none'; document.getElementById('mixTableContainer').style.display=''; };
        updateSenChart();

        document.getElementById('regionSelect').onchange = updateRegChart;
        document.getElementById('variableSelect').onchange = updateRegChart;
        document.getElementById('btnRegChart').onclick = () => { document.getElementById('regChartContainer').style.display=''; document.getElementById('regTableContainer').style.display='none'; };
        document.getElementById('btnRegTable').onclick = () => { document.getElementById('regChartContainer').style.display='none'; document.getElementById('regTableContainer').style.display=''; };
        updateRegChart();
    };
    </script>
</body>
</html>
