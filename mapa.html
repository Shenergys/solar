<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SP-Energy | Monitor SIG Profesional</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/georaster"></script>
    <script src="https://unpkg.com/georaster-layer-for-leaflet"></script>
    <script src="https://unpkg.com/geoblaze"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-measure/dist/leaflet-measure.css" />
    <script src="https://unpkg.com/leaflet-measure/dist/leaflet-measure.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root { --primary: #FFD700; --dark: #2c3e50; }
        body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .main-header { height: 60px; background: #222; color: white; display: flex; align-items: center; padding: 0 20px; z-index: 3000; border-bottom: 3px solid var(--primary); justify-content: space-between; }
        #main-container { display: flex; flex: 1; position: relative; }
        #sidebar { width: 320px; background: white; border-right: 1px solid #ccc; overflow-y: auto; padding: 15px; z-index: 2000; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        #map { flex: 1; background: #e5e5e5; cursor: crosshair !important; }
        .control-block { background: #fff; border: 1px solid #e0e0e0; border-radius: 5px; padding: 10px; margin-bottom: 15px; }
        .control-block h3 { margin: 0 0 10px 0; font-size: 0.85rem; color: var(--dark); border-bottom: 2px solid var(--primary); text-transform: uppercase; }
        .layer-row { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.9rem; }
        .layer-row input { margin-right: 10px; accent-color: var(--primary); cursor: pointer; }
        #inspector-box { position: absolute; top: 20px; right: 20px; width: 280px; background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 1000; border-top: 5px solid var(--dark); }
        .btn-report { width: 100%; margin-top: 10px; background: var(--dark); color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .loading { font-size: 0.7rem; color: #e67e22; display: none; margin-left: auto; }
    </style>
</head>
<body>

    <header class="main-header">
        <div style="font-weight:bold; font-size:1.4rem;">SP-ENERGY ☀️</div>
        <div style="font-size:0.8rem; color:#ccc;">MONITOR SIG DE ALTA PRECISIÓN</div>
    </header>

    <div id="main-container">
        <div id="sidebar">
            <div class="control-block">
                <h3>Variables Climáticas</h3>
                <div class="layer-row">
                    <input type="radio" name="clim" id="chkRad" onclick="toggleTif('rad', 'GHI_FINAL.tif')">
                    <label for="chkRad">Radiación GHI</label><span id="load_rad" class="loading">...</span>
                </div>
                <div class="layer-row">
                    <input type="radio" name="clim" id="chkPot" onclick="toggleTif('pot', 'PV_FINAL.tif')">
                    <label for="chkPot">Potencial FV</label><span id="load_pot" class="loading">...</span>
                </div>
            </div>

            <div class="control-block">
                <h3>Infraestructura CFE</h3>
                <div class="layer-row"><input type="checkbox" onchange="toggleVector('reg', 'mis_9_regiones.json', this)"> Regiones de Control</div>
                <div class="layer-row"><input type="checkbox" onchange="toggleVector('tx', 'lineas_transmision_cfe_24.geojson', this)"> Líneas de Transmisión</div>
                <div class="layer-row"><input type="checkbox" onchange="toggleVector('sub', 'subestaciones_cfe.json', this)"> Subestaciones</div>
            </div>

            <div class="control-block">
                <h3>Territorio</h3>
                <div class="layer-row"><input type="checkbox" onchange="toggleVector('anp', '232_ANP-ITRF08_04072025.json', this)"> Áreas Naturales (ANP)</div>
                <div class="layer-row"><input type="checkbox" onchange="toggleVector('agua', 'hidro4mgw.json', this)"> Ríos</div>
            </div>
        </div>

        <div id="map">
            <div id="inspector-box">
                <h4 style="margin:0 0 10px 0;">INSPECTOR DE DATOS</h4>
                <div id="inspector-content" style="font-size:0.9rem; color:#555;">Selecciona una variable y haz clic en el mapa.</div>
            </div>
        </div>
    </div>

    <script>
        const layers = {};
        let currentReportData = null;
        const map = L.map('map', { center: [23.6, -102.5], zoom: 5, zoomControl: true });
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        // Fix de la regla y el cursor
        setTimeout(() => map.invalidateSize(), 500);
        L.control.measure({ position: 'topleft', primaryLengthUnit: 'kilometers', activeColor: '#FFD700' }).addTo(map);

        // --- MANEJO DE RASTERS (TIF) ---
        async function toggleTif(id, file) {
            ['rad', 'pot'].forEach(k => { if(layers[k]) map.removeLayer(layers[k]); });
            document.getElementById(`load_${id}`).style.display = 'inline';
            try {
                const res = await fetch(`datos/${file}`);
                const buf = await res.arrayBuffer();
                const georaster = await parseGeoraster(buf);
                window.activeRaster = georaster;
                layers[id] = new GeoRasterLayer({
                    georaster: georaster, opacity: 0.7, resolution: 256,
                    pixelValuesToColorFn: v => {
                        if (id === 'rad') return v[0] < 100 ? null : (v[0] > 2000 ? '#b10026' : '#feb24c');
                        return v[0] < 1 ? null : (v[0] > 5 ? '#225ea8' : '#41b6c4');
                    }
                });
                layers[id].addTo(map);
            } catch(e) { console.error("Error:", e); }
            document.getElementById(`load_${id}`).style.display = 'none';
        }

        // --- MANEJO DE VECTORES (JSON) ---
        async function toggleVector(id, file, chk) {
            if (!chk.checked) { if(layers[id]) map.removeLayer(layers[id]); return; }
            if (layers[id]) { layers[id].addTo(map); return; }
            const res = await fetch(`datos/${file}`);
            const data = await res.json();
            layers[id] = L.geoJSON(data, {
                style: () => ({ color: id === 'anp' ? 'green' : (id === 'tx' ? 'blue' : 'gray'), weight: 1.5, fillOpacity: 0.2 }),
                onEachFeature: (f, l) => l.bindPopup(`Elemento: ${f.properties.Nombre || f.properties.Name || id}`)
            }).addTo(map);
        }

        // --- INSPECTOR Y CÁLCULO ---
        map.on('click', async (e) => {
            if (!window.activeRaster) return;
            const result = await geoblaze.identify(window.activeRaster, [e.latlng.lng, e.latlng.lat]);
            if (result) {
                const val = result[0].toFixed(2);
                const isRad = document.getElementById('chkRad').checked;
                currentReportData = { lat: e.latlng.lat.toFixed(5), lng: e.latlng.lng.toFixed(5), val, unit: isRad ? "kWh/m²" : "kWh/kWp" };
                
                document.getElementById('inspector-content').innerHTML = `
                    <b>Ubicación:</b> ${currentReportData.lat}, ${currentReportData.lng}<br>
                    <b>Valor:</b> <span style="font-size:1.2rem; color:#e67e22;">${val} ${currentReportData.unit}</span><hr>
                    <button class="btn-report" onclick="generarPDF()">DESCARGAR REPORTE PDF</button>
                `;
            }
        });

        // --- GENERADOR DE PDF ---
        function generarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18); doc.text("REPORTE TÉCNICO SOLAR SP-ENERGY", 20, 20);
            doc.setFontSize(12); doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 20, 35);
            doc.text(`Coordenadas: ${currentReportData.lat}, ${currentReportData.lng}`, 20, 45);
            doc.text(`Producción estimada: ${currentReportData.val} ${currentReportData.unit} anuales.`, 20, 55);
            doc.text("Este análisis considera un sistema estándar con 75% de eficiencia (PR).", 20, 70);
            doc.save(`Reporte_SP_${currentReportData.lat}.pdf`);
        }
    </script>
</body>
</html>
