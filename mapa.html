<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SP-Energy | Mapas</title>
    <link rel="stylesheet" href="style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* --- Estilos Mapa --- */
        .map-container {
            position: relative;
            height: 600px;
            width: 100%;
            border: 2px solid #ccc;
            border-radius: 5px;
            margin-bottom: 2rem;
            z-index: 1;
        }

        /* --- PANEL DE CAPAS (3 COLUMNAS FIJAS) --- */
        .layers-panel {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 25px;
            margin-bottom: 2rem;
            align-items: start;
        }

        @media (max-width: 900px) {
            .layers-panel { grid-template-columns: 1fr; }
        }

        /* ESTILO DE LAS TARJETAS */
        .layer-group {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-top: 5px solid #FFD700;
            border-left: 1px solid #eee;
            border-right: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }

        .layer-group h3 {
            margin-top: 0; font-size: 1.2rem; color: #2c3e50;
            border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 15px; font-weight: bold;
        }

        .layer-item {
            display: flex; align-items: center; margin-bottom: 10px;
            font-size: 0.95rem; color: #444; padding: 5px; border-radius: 4px; transition: background 0.2s;
        }

        .layer-item:hover { background-color: #f9f9f9; }

        .layer-item input {
            margin-right: 12px; transform: scale(1.3); cursor: pointer; accent-color: #FFD700;
        }

        /* Tabla y Glosario */
        #tableSection { display: none; margin-top: 2rem; }
        .glossary-section { margin-top: 3rem; border-top: 1px solid #ccc; padding-top: 2rem; }
        #glossaryContent { display: none; background: #f4f4f4; padding: 20px; border-radius: 5px; margin-top: 15px; border-left: 5px solid #2c3e50; }
        .glossary-item { margin-bottom: 10px; }
        .term { font-weight: bold; color: #d35400; }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="logo-container"><span class="logo-text">SP-ENERGY <span class="sun-icon">‚òÄÔ∏è</span></span></div>
        <div class="slogan-container"><h1>Energ√≠a Solar para Todos</h1></div>
        <div class="spacer"></div> 
    </header>

    <nav class="navbar">
        <ul>
            <li><a href="index.html">Inicio</a></li>
            <li><a href="mapa.html" class="active">Mapas</a></li>
            <li><a href="graficas.html">Gr√°ficas y Tablas</a></li>
            <li><a href="emisiones.html">Emisiones</a></li>
            <li><a href="info.html">Contacto</a></li>
        </ul>
    </nav>

    <main class="main-container">
        
        <h2 class="section-title">Visualizador Geogr√°fico</h2>

        <section class="graph-card" style="padding-bottom: 15px;">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                <div class="view-toggle">
                    <button id="btnGeneral" class="btn primary">Mapa General</button>
                    <button id="btnPV" class="btn">Mapa Fotovoltaico</button>
                </div>
                <button id="btnShowTable" class="btn" style="background-color: #2c3e50; color: white;">Ver Tabla de Datos</button>
            </div>
        </section>

        <div id="map" class="map-container"></div>

        <div id="panelGeneral" class="layers-panel">
            <div class="layer-group">
                <h3>‚òÄÔ∏è Energ√≠a (Capas Base)</h3>
                <div class="layer-item"><input type="checkbox" value="rad"><label>Radiaci√≥n Solar</label></div>
                <div class="layer-item"><input type="checkbox" value="pot"><label>Potencial Fotovoltaico</label></div>
                <div class="layer-item"><input type="checkbox" value="cent"><label>Centrales Fotovoltaicas</label></div>
            </div>
            <div class="layer-group">
                <h3>üåç Territorio y Clima</h3>
                <div class="layer-item"><input type="checkbox" value="anp"><label>√Åreas Naturales Protegidas (ANP)</label></div>
                <div class="layer-item"><input type="checkbox" value="hum"><label>Asentamientos Humanos</label></div>
                <div class="layer-item"><input type="checkbox" value="agua"><label>Cuerpos de Agua</label></div>
            </div>
            <div class="layer-group">
                <h3>‚ö° Infraestructura SEN</h3>
                <div class="layer-item"><input type="checkbox" value="reg"><label>Divisi√≥n de Regiones</label></div>
                <div class="layer-item"><input type="checkbox" value="tx"><label>L√≠neas de Transmisi√≥n</label></div>
                <div class="layer-item"><input type="checkbox" value="sub"><label>Subestaciones El√©ctricas</label></div>
            </div>
        </div>

        <div id="panelPV" class="layers-panel" style="display:none;">
            <div class="layer-group">
                <h3>‚òÄÔ∏è Indicadores T√©cnicos</h3>
                <div class="layer-item"><input type="checkbox" value="potPV"><label>Potencial Fotovoltaico</label></div>
                <div class="layer-item"><input type="checkbox" value="centPV"><label>Centrales Fotovoltaicas</label></div>
            </div>
            <div class="layer-group">
                <h3>üìä Datos Regionales</h3>
                <div class="layer-item"><input type="checkbox" value="capReg"><label>Capacidad Instalada</label></div>
                <div class="layer-item"><input type="checkbox" value="genReg"><label>Generaci√≥n El√©ctrica</label></div>
                <div class="layer-item"><input type="checkbox" value="demReg"><label>Demanda M√°xima</label></div>
            </div>
            <div class="layer-group">
                <h3>üìç Referencia</h3>
                <div class="layer-item"><input type="checkbox" value="regPV" checked disabled><label>Divisi√≥n de Regiones</label></div>
            </div>
        </div>

        <section id="tableSection" class="graph-card">
            <h3>Datos Regionales (Cierre 2024)</h3>
            <table class="data-table">
                <thead>
                    <tr><th>Regi√≥n</th><th>Capacidad (MW)</th><th>Generaci√≥n (GWh)</th><th>Demanda M√°x (MW)</th></tr>
                </thead>
                <tbody id="tableBodyData"></tbody>
            </table>
        </section>

        <section class="glossary-section">
            <button id="btnGlossary" class="btn" style="background:#333; color:white; width:100%;">Ver Glosario de T√©rminos</button>
            <div id="glossaryContent">
                <h3>Glosario</h3>
                <div class="glossary-item"><span class="term">ANP:</span> √Åreas Naturales Protegidas.</div>
                <div class="glossary-item"><span class="term">SEN:</span> Sistema El√©ctrico Nacional.</div>
            </div>
        </section>

    </main>

    <footer><p>&copy; 2025 SP-Energy.</p></footer>

    <script>
        // --- 1. CONFIGURACI√ìN DEL MAPA (Restringido a M√©xico) ---
        
        // Coordenadas de la "Caja" que encierra a M√©xico
        const boundsMexico = [
            [13.0, -120.0], // Esquina Sur-Oeste (con margen)
            [34.0, -85.0]   // Esquina Norte-Este (con margen)
        ];

        const map = L.map('map', {
            center: [23.6345, -102.5528], // Centro de M√©xico
            zoom: 5,
            minZoom: 5,       // No permite alejarse m√°s all√° de ver todo el pa√≠s
            maxBounds: boundsMexico, // Activa la "cerca virtual"
            maxBoundsViscosity: 1.0  // Qu√© tan duro es el rebote (1.0 = muro s√≥lido)
        });
        
        // --- 2. CAMBIO DE ESTILO (DE CLARO A OSCURO) ---
        // Antes us√°bamos 'light_all'. Ahora usamos 'dark_all' para contraste.
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CARTO'
        }).addTo(map);

        // --- 3. ORDEN DE CAPAS (Z-INDEX) ---
        map.createPane('paneRaster'); map.getPane('paneRaster').style.zIndex = 200;
        map.createPane('panePoligonos'); map.getPane('panePoligonos').style.zIndex = 400;
        map.createPane('paneLineas'); map.getPane('paneLineas').style.zIndex = 500;
        map.createPane('panePuntos'); map.getPane('panePuntos').style.zIndex = 600;

        // --- 4. TUS IM√ÅGENES (Mapas de calor) ---
        // Ajustamos la opacidad un poco para que se vean bien sobre fondo oscuro
        const imageBounds = [[14.53, -117.12], [32.72, -86.71]];
        const layerPot = L.imageOverlay('pvout.png', imageBounds, { opacity: 0.7, pane: 'paneRaster' });
        const layerRad = L.imageOverlay('rad.png', imageBounds, { opacity: 0.7, pane: 'paneRaster' });

        // --- 5. FUNCI√ìN CARGADORA ---
        async function loadLayer(url, type, styleOpts) {
            try {
                const response = await fetch(url);
                if (!response.ok) return L.layerGroup();
                const data = await response.json();
                
                if (type === 'line') {
                    return L.geoJSON(data, { style: styleOpts, pane: 'paneLineas' });
                } else if (type === 'point') {
                    return L.geoJSON(data, {
                        pointToLayer: (feature, latlng) => L.circleMarker(latlng, styleOpts),
                        pane: 'panePuntos',
                        onEachFeature: (f, l) => {
                            let txt = "Subestaci√≥n";
                            if(f.properties) {
                                if(f.properties.Name) txt = `<b>${f.properties.Name}</b>`;
                                if(f.properties.Voltaje_KV) txt += `<br>${f.properties.Voltaje_KV} KV`;
                            }
                            l.bindPopup(txt);
                        }
                    });
                } else if (type === 'poly') {
                    return L.geoJSON(data, { 
                        style: styleOpts, pane: 'panePoligonos', 
                        onEachFeature: (f, l) => l.bindPopup(`<b>${f.properties.REGION || 'Regi√≥n'}</b>`) 
                    });
                }
            } catch (e) { return L.layerGroup(); }
        }

        // --- ESTILOS (AJUSTADOS PARA FONDO OSCURO) ---
        // Regiones: Blancas sutiles en lugar de gris oscuro
        const stReg = { color: '#ecf0f1', weight: 1, fillOpacity: 0.05, dashArray: '4, 4' }; 
        // L√≠neas: Cyan/Ne√≥n para que brillen
        const stTx = { color: '#00d2ff', weight: 1.5, opacity: 0.9 }; 
        // Subestaciones: Amarillas brillantes
        const stSub = { radius: 3, fillColor: '#f1c40f', color: '#fff', weight: 1, fillOpacity: 1 }; 
        // Asentamientos: Magenta ne√≥n
        const stHum = { color: 'none', fillColor: '#d63384', fillOpacity: 0.4 }; 

        // --- 6. CARGA DE DATOS ---
        let layerReg, layerTx, layerSub, layerHumanos;

        (async () => {
            layerReg = await loadLayer('datos/mis_9_regiones.json', 'poly', stReg);
            layerTx = await loadLayer('datos/lineas_transmision_cfe_24.geojson', 'line', stTx);
            layerSub = await loadLayer('datos/subestaciones_cfe.json', 'point', stSub);
            
            layerHumanos = L.layerGroup();
            const estados = ["AGS","BC","BCS","CAMP","COAH","COL","CHIS","CHIH","CDMX","DGO","GTO","GRO","HGO","JAL","MEX","MICH","MOR","NAY","NL","OAX","PUE","QRO","QROO","SLP","SIN","SON","TAB","TAMPS","TLAX","VER","YUC","ZAC"];
            
            estados.forEach(edo => {
                fetch(`datos/asentamientos/ZONAHUMANO_${edo}.json`)
                    .then(res => res.json())
                    .then(data => L.geoJSON(data, { style: stHum, pane: 'panePoligonos' }).addTo(layerHumanos))
                    .catch(e => null); 
            });

            updateControls();
        })();

        // --- 7. CONTROLADOR DE CAPAS ---
        let layersMap = { 'rad': layerRad, 'pot': layerPot, 'potPV': layerPot };

        function updateControls() {
            layersMap['reg'] = layerReg; layersMap['regPV'] = layerReg;
            layersMap['tx'] = layerTx;
            layersMap['sub'] = layerSub;
            layersMap['hum'] = layerHumanos;
            layersMap['capReg'] = layerReg; 
            layersMap['genReg'] = layerReg; 
            layersMap['demReg'] = layerReg;
        }

        document.querySelectorAll('input[type="checkbox"]').forEach(chk => {
            chk.addEventListener('change', (e) => {
                const id = e.target.value;
                if(layersMap[id]) {
                    e.target.checked ? layersMap[id].addTo(map) : layersMap[id].remove();
                }
            });
        });

        // BOTONES DE VISTA
        const btnGen = document.getElementById('btnGeneral');
        const btnPV = document.getElementById('btnPV');
        const pGen = document.getElementById('panelGeneral');
        const pPV = document.getElementById('panelPV');

        btnGen.addEventListener('click', () => {
            btnGen.classList.add('primary'); btnPV.classList.remove('primary');
            pGen.style.display = 'grid'; pPV.style.display = 'none';
            resetMap();
        });

        btnPV.addEventListener('click', () => {
            btnPV.classList.add('primary'); btnGen.classList.remove('primary');
            pGen.style.display = 'none'; pPV.style.display = 'grid';
            resetMap();
        });

        function resetMap() {
            map.eachLayer(l => { if(l !== map._layers[Object.keys(map._layers)[0]]) map.removeLayer(l); });
            document.querySelectorAll('input').forEach(i => i.checked = false);
            // Re-agregamos el mapa oscuro base
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        }

        // TABLA Y GLOSARIO
        const btnTable = document.getElementById('btnShowTable');
        const tableSec = document.getElementById('tableSection');
        const tbody = document.getElementById('tableBodyData');
        const dataRegiones = [
            {r: "CEN", d: 8848}, {r: "ORI", d: 9034}, {r: "OCC", d: 11834}, {r: "NOR", d: 5909},
            {r: "NTE", d: 5540}, {r: "NES", d: 11109}, {r: "PEN", d: 2969}, {r: "SIN", d: 55243}
        ];
        // Limpiamos tabla antes de llenar para evitar duplicados si recargas
        tbody.innerHTML = ''; 
        dataRegiones.forEach(d => { tbody.innerHTML += `<tr><td><strong>${d.r}</strong></td><td>-</td><td>-</td><td>${d.d.toLocaleString()}</td></tr>`; });

        btnTable.addEventListener('click', () => {
            if(tableSec.style.display === 'block'){ tableSec.style.display = 'none'; btnTable.textContent = 'Ver Tabla de Datos'; }
            else { tableSec.style.display = 'block'; btnTable.textContent = 'Ocultar Tabla'; }
        });

        const btnGlos = document.getElementById('btnGlossary');
        const divGlos = document.getElementById('glossaryContent');
        btnGlos.addEventListener('click', () => {
            if(divGlos.style.display === 'block') { divGlos.style.display = 'none'; btnGlos.textContent = 'Ver Glosario de T√©rminos'; }
            else { divGlos.style.display = 'block'; btnGlos.textContent = 'Ocultar Glosario'; }
        });
    </script>
</body>
</html>
