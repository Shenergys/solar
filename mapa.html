<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SP-Energy | Mapas</title>
    <link rel="stylesheet" href="style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <style>
        /* Estilos Mapa */
        .map-container {
            position: relative; height: 600px; width: 100%;
            border: 2px solid #ccc; border-radius: 5px; margin-bottom: 2rem; z-index: 1;
            background-color: #aad3df; /* Color del mar por si carga lento */
        }

        /* PANEL DE CAPAS (3 COLUMNAS) */
        .layers-panel {
            display: grid; grid-template-columns: repeat(3, 1fr); 
            gap: 25px; margin-bottom: 2rem; align-items: start;
        }
        @media (max-width: 900px) { .layers-panel { grid-template-columns: 1fr; } }

        /* TARJETAS */
        .layer-group {
            background: #fff; padding: 20px; border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-top: 5px solid #FFD700;
            border: 1px solid #eee;
        }
        .layer-group h3 {
            margin-top: 0; font-size: 1.2rem; color: #2c3e50;
            border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 15px; font-weight: bold;
        }
        .layer-item { display: flex; align-items: center; margin-bottom: 10px; font-size: 0.95rem; color: #444; }
        .layer-item input { margin-right: 12px; transform: scale(1.3); cursor: pointer; accent-color: #FFD700; }

        /* Tabla y Glosario */
        #tableSection, #glossaryContent { display: none; margin-top: 2rem; }
        .glossary-section { margin-top: 3rem; border-top: 1px solid #ccc; padding-top: 2rem; }
        #glossaryContent { background: #f4f4f4; padding: 20px; border-radius: 5px; border-left: 5px solid #2c3e50; }
        .term { font-weight: bold; color: #d35400; }
        
        /* Leyenda de Colores de Regiones */
        .legend-color { width: 12px; height: 12px; display: inline-block; margin-right: 5px; border-radius: 2px; }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="logo-container"><span class="logo-text">SP-ENERGY <span class="sun-icon">‚òÄÔ∏è</span></span></div>
        <div class="slogan-container"><h1>Energ√≠a Solar para Todos</h1></div>
        <div class="spacer"></div> 
    </header>

    <nav class="navbar">
        <ul>
            <li><a href="index.html">Inicio</a></li>
            <li><a href="mapa.html" class="active">Mapas</a></li>
            <li><a href="graficas.html">Gr√°ficas y Tablas</a></li>
            <li><a href="emisiones.html">Emisiones</a></li>
            <li><a href="info.html">Contacto</a></li>
        </ul>
    </nav>

    <main class="main-container">
        
        <h2 class="section-title">Visualizador Geogr√°fico</h2>

        <section class="graph-card" style="padding-bottom: 15px;">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                <div class="view-toggle">
                    <button id="btnGeneral" class="btn primary">Mapa General</button>
                    <button id="btnPV" class="btn">Mapa Fotovoltaico</button>
                </div>
                <button id="btnShowTable" class="btn" style="background-color: #2c3e50; color: white;">Ver Tabla de Datos</button>
            </div>
        </section>

        <div id="map" class="map-container"></div>

        <div id="panelGeneral" class="layers-panel">
            <div class="layer-group">
                <h3>‚òÄÔ∏è Energ√≠a (Capas Base)</h3>
                <div class="layer-item"><input type="checkbox" value="rad"><label>Radiaci√≥n Solar</label></div>
                <div class="layer-item"><input type="checkbox" value="pot"><label>Potencial Fotovoltaico</label></div>
                <div class="layer-item"><input type="checkbox" value="cent"><label>Centrales Fotovoltaicas</label></div>
            </div>
            <div class="layer-group">
                <h3>üåç Territorio y Clima</h3>
                <div class="layer-item"><input type="checkbox" value="anp"><label>√Åreas Naturales Protegidas (ANP)</label></div>
                <div class="layer-item"><input type="checkbox" value="hum"><label>Asentamientos Humanos</label></div>
                <div class="layer-item"><input type="checkbox" value="agua"><label>Cuerpos de Agua</label></div>
            </div>
            <div class="layer-group">
                <h3>‚ö° Infraestructura SEN</h3>
                <div class="layer-item"><input type="checkbox" value="reg"><label>Divisi√≥n de Regiones</label></div>
                <div class="layer-item"><input type="checkbox" value="tx"><label>L√≠neas de Transmisi√≥n</label></div>
                <div class="layer-item"><input type="checkbox" value="sub"><label>Subestaciones (Agrupadas)</label></div>
            </div>
        </div>

        <div id="panelPV" class="layers-panel" style="display:none;">
            <div class="layer-group">
                <h3>‚òÄÔ∏è Indicadores T√©cnicos</h3>
                <div class="layer-item"><input type="checkbox" value="potPV"><label>Potencial Fotovoltaico</label></div>
                <div class="layer-item"><input type="checkbox" value="centPV"><label>Centrales Fotovoltaicas</label></div>
            </div>
            <div class="layer-group">
                <h3>üìä Datos Regionales (Color)</h3>
                <div class="layer-item"><input type="checkbox" value="capReg"><label>Capacidad Instalada</label></div>
                <div class="layer-item"><input type="checkbox" value="genReg"><label>Generaci√≥n El√©ctrica</label></div>
            </div>
            <div class="layer-group">
                <h3>üìç Referencia</h3>
                <div class="layer-item"><input type="checkbox" value="regPV" checked disabled><label>Divisi√≥n de Regiones</label></div>
            </div>
        </div>

        <section id="tableSection" class="graph-card">
            <h3>Datos Regionales (Cierre 2024)</h3>
            <table class="data-table">
                <thead><tr><th>Regi√≥n</th><th>Capacidad (MW)</th><th>Generaci√≥n (GWh)</th><th>Demanda M√°x (MW)</th></tr></thead>
                <tbody id="tableBodyData"></tbody>
            </table>
        </section>

        <section class="glossary-section">
            <button id="btnGlossary" class="btn" style="background:#333; color:white; width:100%;">Ver Glosario de T√©rminos</button>
            <div id="glossaryContent">
                <h3>Glosario</h3>
                <div class="glossary-item"><span class="term">ANP:</span> √Åreas Naturales Protegidas.</div>
                <div class="glossary-item"><span class="term">SEN:</span> Sistema El√©ctrico Nacional.</div>
            </div>
        </section>

    </main>

    <footer><p>&copy; 2025 SP-Energy.</p></footer>

    <script>
        // --- 1. CONFIGURACI√ìN DEL MAPA ---
        const map = L.map('map', {
            center: [23.6345, -102.5528], zoom: 5, minZoom: 5,
            maxBounds: [[13.0, -120.0], [34.0, -85.0]], maxBoundsViscosity: 1.0
        });
        
        // --- ESTILO "NATIONAL GEOGRAPHIC" (Esri Ocean) ---
        // Azul oscuro en el mar, relieve en la tierra. Muy profesional.
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri', maxZoom: 10
        }).addTo(map);

        // --- ORDEN DE CAPAS ---
        map.createPane('paneRaster'); map.getPane('paneRaster').style.zIndex = 200;
        map.createPane('panePoligonos'); map.getPane('panePoligonos').style.zIndex = 400;
        map.createPane('paneLineas'); map.getPane('paneLineas').style.zIndex = 500;
        
        // --- IM√ÅGENES ---
        const imageBounds = [[14.53, -117.12], [32.72, -86.71]];
        const layerPot = L.imageOverlay('pvout.png', imageBounds, { opacity: 0.65, pane: 'paneRaster' });
        const layerRad = L.imageOverlay('rad.png', imageBounds, { opacity: 0.65, pane: 'paneRaster' });

        // --- 2. PALETA DE COLORES PARA REGIONES ---
        // Asigna un color seg√∫n el nombre de la regi√≥n
        function getColorRegion(nombre) {
            if(!nombre) return '#999';
            const n = nombre.toUpperCase();
            if(n.includes("NOROESTE") || n.includes("NOR")) return '#E41A1C'; // Rojo
            if(n.includes("NORESTE") || n.includes("NES")) return '#377EB8'; // Azul
            if(n.includes("OCCIDENTAL") || n.includes("OCC")) return '#4DAF4A'; // Verde
            if(n.includes("CENTRAL") || n.includes("CEN")) return '#984EA3'; // Morado
            if(n.includes("ORIENTAL") || n.includes("ORI")) return '#FF7F00'; // Naranja
            if(n.includes("PENINSULAR") || n.includes("PEN")) return '#FFFF33'; // Amarillo
            if(n.includes("BAJA")) return '#A65628'; // Caf√©
            return '#F781BF'; // Rosa (Default)
        }

        function styleRegiones(feature) {
            return {
                fillColor: getColorRegion(feature.properties.REGION || feature.properties.nombre),
                weight: 1.5,
                opacity: 1,
                color: 'white', // Borde blanco
                dashArray: '3',
                fillOpacity: 0.4 // Transparencia para ver el mapa abajo
            };
        }

        // --- 3. CARGA DE DATOS ---
        async function loadLayer(url, type, styleOpts) {
            try {
                const response = await fetch(url);
                if (!response.ok) return L.layerGroup();
                const data = await response.json();
                
                if (type === 'line') {
                    return L.geoJSON(data, { style: styleOpts, pane: 'paneLineas' });
                } else if (type === 'poly') {
                    // Si es Regi√≥n, usa la funci√≥n de colores. Si no (ej. ANP), usa el estilo fijo.
                    if(url.includes('regiones')) {
                        return L.geoJSON(data, { 
                            style: styleRegiones, // AQUI SE APLICA EL COLOR
                            pane: 'panePoligonos',
                            onEachFeature: (f, l) => l.bindPopup(`<b>Regi√≥n: ${f.properties.REGION}</b>`)
                        });
                    } else {
                        return L.geoJSON(data, { style: styleOpts, pane: 'panePoligonos' });
                    }
                }
            } catch (e) { return L.layerGroup(); }
        }

        // Estilos Fijos
        const stTx = { color: '#2c3e50', weight: 1.5 }; // L√≠neas oscuras
        const stHum = { color: 'none', fillColor: '#581845', fillOpacity: 0.5 }; // Asentamientos Vino

        // --- CLUSTERING DE SUBESTACIONES ---
        // Esta variable guardar√° el grupo de "bolitas"
        let markerClusterSub = L.markerClusterGroup(); 

        async function cargarSubestaciones() {
            try {
                const response = await fetch('datos/subestaciones_cfe.json');
                const data = await response.json();
                
                // Convertimos cada punto en un marcador y lo agregamos al cluster
                const geoJsonLayer = L.geoJSON(data, {
                    pointToLayer: function (feature, latlng) {
                        // Marcador est√°ndar (se agrupa solo)
                        return L.marker(latlng);
                    },
                    onEachFeature: (f, l) => {
                        let txt = "<b>Subestaci√≥n</b>";
                        if(f.properties.Name) txt = `<b>${f.properties.Name}</b>`;
                        if(f.properties.Voltaje_KV) txt += `<br>${f.properties.Voltaje_KV} KV`;
                        l.bindPopup(txt);
                    }
                });
                markerClusterSub.addLayer(geoJsonLayer);
            } catch(e) { console.log("Error subestaciones"); }
        }

        // --- INICIALIZACI√ìN ---
        let layerReg, layerTx, layerHumanos;

        (async () => {
            // Cargar capas normales
            layerReg = await loadLayer('datos/mis_9_regiones.json', 'poly', null);
            layerTx = await loadLayer('datos/lineas_transmision_cfe_24.geojson', 'line', stTx);
            
            // Cargar subestaciones con Clustering
            await cargarSubestaciones();

            // Cargar Estados
            layerHumanos = L.layerGroup();
            const estados = ["AGS","BC","BCS","CAMP","COAH","COL","CHIS","CHIH","CDMX","DGO","GTO","GRO","HGO","JAL","MEX","MICH","MOR","NAY","NL","OAX","PUE","QRO","QROO","SLP","SIN","SON","TAB","TAMPS","TLAX","VER","YUC","ZAC"];
            estados.forEach(edo => {
                fetch(`datos/asentamientos/ZONAHUMANO_${edo}.json`)
                    .then(res => res.json())
                    .then(data => L.geoJSON(data, { style: stHum, pane: 'panePoligonos' }).addTo(layerHumanos))
                    .catch(e => null); 
            });

            updateControls();
        })();

        // --- CONTROLADOR ---
        let layersMap = { 'rad': layerRad, 'pot': layerPot, 'potPV': layerPot };

        function updateControls() {
            layersMap['reg'] = layerReg; layersMap['regPV'] = layerReg;
            layersMap['tx'] = layerTx;
            layersMap['sub'] = markerClusterSub; // Aqu√≠ conectamos el cluster
            layersMap['hum'] = layerHumanos;
            
            layersMap['capReg'] = layerReg; layersMap['genReg'] = layerReg; 
        }

        document.querySelectorAll('input[type="checkbox"]').forEach(chk => {
            chk.addEventListener('change', (e) => {
                const id = e.target.value;
                if(layersMap[id]) e.target.checked ? layersMap[id].addTo(map) : layersMap[id].remove();
            });
        });

        // BOTONES
        const btnGen = document.getElementById('btnGeneral');
        const btnPV = document.getElementById('btnPV');
        const pGen = document.getElementById('panelGeneral');
        const pPV = document.getElementById('panelPV');

        btnGen.onclick = () => {
            btnGen.classList.add('primary'); btnPV.classList.remove('primary');
            pGen.style.display = 'grid'; pPV.style.display = 'none';
            resetMap();
        };

        btnPV.onclick = () => {
            btnPV.classList.add('primary'); btnGen.classList.remove('primary');
            pGen.style.display = 'none'; pPV.style.display = 'grid';
            resetMap();
        };

        function resetMap() {
            map.eachLayer(l => { if(l !== map._layers[Object.keys(map._layers)[0]]) map.removeLayer(l); });
            document.querySelectorAll('input').forEach(i => i.checked = false);
            // Re-agregar base Esri Ocean
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri', maxZoom: 10 }).addTo(map);
        }

        // TABLA Y GLOSARIO
        const btnTable = document.
